var fuse; // holds our search engine
var firstRun = true; // allow us to delay loading json data unless search activated
var list = document.getElementById('searchResults'); // targets 
if ( list != undefined ) {
    var first = list.firstChild; // first child of search list
    var last = list.lastChild; // last child of search list
}
var maininput = document.getElementById('searchInput'); // input box for search
var resultsAvailable = false; // Did we get any search results?

// Load json search index if first time invoking search
// Means we don't load json unless searches are going to happen; keep user payload small unless needed
if( firstRun && list != undefined && maininput != undefined ) {
  loadSearch(); // loads our json data and builds fuse.js search index
  firstRun = false; // let's never do this again
}

if ( maininput != undefined ) {
    document.getElementById("searchInput").onkeyup = function(e) {
      executeSearch(this.value);
    }
  }

function fetchJSONFile(path, callback) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
      if (httpRequest.readyState === 4) {
        if (httpRequest.status === 200) {
          var data = JSON.parse(httpRequest.responseText);
            if (callback) callback(data);
        }
      }
    };
    httpRequest.open('GET', path);
    httpRequest.send();
  }

  function loadSearch() {
    fetchJSONFile('/index.json', function(data){

    var options = { // fuse.js options; check fuse.js website for details
      shouldSort: true,
      location: 0,
      distance: 100,
      threshold: 0.4,
      minMatchCharLength: 2,
      keys: [
        'title',
        'tags',
        'content',
        'excerpt',
      ]
    };
    fuse = new Fuse(data, options); // build the index from the json file
  });
}

function executeSearch(term) {
    let results = fuse.search(term); // the actual query being run using fuse.js
    //let results = [];
    let searchitems = ''; // our results bucket
  
    if (results.length === 0) { // no results based on what was typed into the input box
      resultsAvailable = false;
      searchitems = '';
    } else { // build our html
      for (let item in results) { // only show first 5 results
        searchitems = results.slice(0,5).map(x => `<a href="${x.item.url}">
        <span class="search-image-box" style="background-image: url('${x.item.cover || ""}')"></span>
        <h3>${x.item.title}</h3>
        <span>${x.item.content || x.item.excerpt || ""}</span>
        </a>`)
        .join("");
      }
      resultsAvailable = true;
    }
  
    document.getElementById("searchResults").innerHTML = searchitems;
    if (results.length > 0) {
        first = list.firstChild.firstElementChild; // first result container — used for checking against keyboard up/down location
        last = list.lastChild.firstElementChild; // last result container — used for checking against keyboard up/down location
    }
  }
  

